{% extends 'frame.html' %}
{% block content %}
    <h4>Docker Endpoint: {{ endpoint.name }}</h4>
    <p><b>Kernel Version:</b> {{ endpoint.data.KernelVersion }}</p>
    <p><b>Containers:</b> {{ endpoint.data.Containers }} ({{ endpoint.data.ContainersRunning }} Running, {{ endpoint.data.ContainersPaused }} Paused, {{ endpoint.data.ContainersStopped }} Stopped)</p>
    <hr/>
    <h4>Images</h4>
    <p>Manage docker images, pull or push, or create one for LEDEForge.</p>
    <button class="btn btn-default" data-toggle="modal" data-target="#docker_build_modal">Build LEDEForge Worker Here</button>
    <button class="btn btn-default" data-toggle="modal" data-target="#docker_pull_modal">Pull from Registry</button>
    <br/>
    <br/>
    <p><b>Note:</b> Only images generated by LEDEForge are shown here.</p>
    <table class="table">
        <thead>
        <tr>
            <th>Image ID</th>
            <th>Size</th>
            <th>Operation</th>
        </tr>
        </thead>
        <tbody>
        {% for k in endpoint.images %}
            <tr>
                <td style="font-family: monospace">{{ k.Id | slice:"7:23" }}</td>
                <td>{{ k.Size | filesizeformat }}</td>
                <td>
                    <div class="btn-group btn-group-xs">
                        <button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Operation <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a href="#" onclick="show_create_container_modal('{{ k.Id | slice:"7:" }}')">Create Container from Image</a></li>
                            <li role="separator" class="divider"></li>
                            <li><a href="#" onclick="show_push_image_modal('{{ k.Id | slice:"7:" }}')">Push to Docker Registry</a></li>
                        </ul>
                    </div>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    <h4>Containers</h4>
    <p>Show LEDEForge containers on this endpoint.</p>
    <p><b>Note:</b> Containers not created by LEDEForge Image won't show up here.</p>
    <table class="table">
        <thead>
        <tr>
            <th>Container ID</th>
            <th>Image ID</th>
            <th>Command</th>
            <th>Status and Operation</th>
        </tr>
        </thead>
        <tbody>
        {% for k in endpoint.containers %}
            <tr>
                <td style="font-family: monospace">{{ k.Id | slice:"16" }}</td>
                <td style="font-family: monospace">{{ k.Image | cut:"sha256:" | slice:"16" }}</td>
                <td style="font-family: monospace">{{ k.Command | slice:"43" }}</td>
                <td>
                    <div class="btn-group btn-group-xs">
                        <button type="button" class="btn btn-xs btn-default">{{ k.State }}</button>
                        <button type="button" class="btn btn-xs btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <span class="caret"></span>
                            <span class="sr-only">Toggle Dropdown</span>
                        </button>
                        <ul class="dropdown-menu">
                            {% if k.State != 'running' %}
                            <li><a href="#" onclick="change_container_status('{{ k.Id | slice:"16" }}', 'start')">Start</a></li>
                            {% else %}
                            <li><a href="#" onclick="change_container_status('{{ k.Id | slice:"16" }}', 'stop')">Stop</a></li>
                            <li><a href="#" onclick="change_container_status('{{ k.Id | slice:"16" }}', 'restart')">Restart</a></li>
                            {% endif %}
                            <li role="separator" class="divider"></li>
                            <li><a href="#" onclick="show_import_into_ledeforge_modal('{{ k.Id | slice:"16" }}', '{{ k.Ports.0.PublicPort }}')">Import Into LEDEForge</a></li>
                        </ul>
                    </div>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    <script type="text/javascript">
        function change_container_status(container_id, status) {
            $.post('{% url 'endpoint_docker_container_op' endpoint.id %}', {
                container_id: container_id,
                status: status
            }, function (data, status, xhr) {
                location.reload()
            });
        }

        function show_import_into_ledeforge_modal(container_id, public_port) {
            $("#container_id_import").val(container_id);
            $("#public_port_import").val(public_port);
            $("#connstr_import").val("{{ endpoint.default_connection_string }}:" + public_port);
            $("#ledeforge_import_modal").modal()
        }
    </script>
{% endblock %}
{% block model %}
    <div class="modal fade" id="docker_build_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">Build LEDEForge Worker Image</h4>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="ignore">Select DockerFile</label>
                        <select id="ignore" class="form-control">
                            <option value=".">LEDEForge DockerFile</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="button" onclick="start_build()" class="btn btn-primary">Start Build</button>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        function start_build() {
            const v = $("#ignore").val();
            console.log(v);
            $.post('{% url 'endpoint_docker_build' endpoint.id %}', {path: v}, function (data, status, xhr) {
                location.href = '{% url 'queue_output' "aaaaaaaaaa" %}'.replace("aaaaaaaaaa", data.queue_id)
            });
        }
    </script>
    <div class="modal fade" id="docker_create_container_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">Create LEDEForge Container from LEDEForge Image</h4>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="image_id_create_container">Image ID</label>
                        <input type="text" disabled="disabled" id="image_id_create_container" class="form-control" aria-label="Image ID" placeholder="" value="">
                    </div>
                    <div class="form-group">
                        <label for="port">Expose Port For LEDEForge Access</label>
                        <div class="input-group">
                            <span class="input-group-addon">0.0.0.0:</span>
                            <input type="text" id="port" class="form-control" aria-label="Port for LEDEForge Worker" placeholder="8765" value="8765">
                            <span class="input-group-addon">:8765/tcp</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="create_container()">Create Container</button>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        function show_create_container_modal(image_id) {
            $("#image_id_create_container").val(image_id);
            $("#docker_create_container_modal").modal()
        }

        function create_container() {
            const image_id = $("#image_id_create_container").val();
            const port = $("#port").val();
            $.post('{% url 'endpoint_docker_run' endpoint.id %}', {image_id: image_id, port: port}, function (data, status, xhr) {
                location.reload()
            });
        }
    </script>
    <div class="modal fade" id="docker_push_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">Push Image to Registry</h4>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="image_id_push">Image ID</label>
                        <input type="text" disabled="disabled" id="image_id_push" class="form-control" aria-label="Image ID" placeholder="" value="">
                    </div>
                    <div class="form-group">
                        <label for="registry">Select Registry</label>
                        <select id="registry" class="form-control">
                            {% for reg in registry %}
                            <option value="{{ reg.connection_string }}">{{ reg.name }} ({{ reg.connection_string }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="image_name_push">Image Name</label>
                        <input type="text" id="image_name_push" class="form-control" aria-label="Port for LEDEForge Worker" placeholder="ledeforge" value="ledeforge">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="push_image()">Push</button>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        function show_push_image_modal(image_id) {
            $("#image_id_push").val(image_id);
            $("#docker_push_modal").modal()
        }

        function push_image() {
            const image_id = $("#image_id_push").val();
            const registry = $("#registry").val();
            const image_name = $("#image_name_push").val();
            $.post('{% url 'endpoint_docker_push' endpoint.id %}', {image_id: image_id, image_name: image_name, registry: registry}, function (data, status, xhr) {
                location.href = '{% url 'queue_output' "aaaaaaaaaa" %}'.replace("aaaaaaaaaa", data.queue_id)
            });
        }
    </script>
    <div class="modal fade" id="docker_pull_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">Pull from Registry</h4>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="registry">Select Registry</label>
                        <select id="registry" class="form-control">
                            {% for reg in registry %}
                            <option value="{{ reg.connection_string }}">{{ reg.name }} ({{ reg.connection_string }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="image_name_pull">Image Name</label>
                        <input type="text" id="image_name_pull" class="form-control" aria-label="Port for LEDEForge Worker" placeholder="ledeforge" value="ledeforge">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="pull_image()">Pull</button>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        function pull_image() {
            const registry = $("#registry").val();
            const image_name = $("#image_name_pull").val();
            $.post('{% url 'endpoint_docker_pull' endpoint.id %}', {image_name: image_name, registry: registry}, function (data, status, xhr) {
                location.href = '{% url 'queue_output' "aaaaaaaaaa" %}'.replace("aaaaaaaaaa", data.queue_id)
            });
        }
    </script>
    <div class="modal fade" id="ledeforge_import_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">Import container into LEDEForge</h4>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="container_id_import">Container ID</label>
                        <input type="text" disabled="disabled" id="container_id_import" class="form-control" aria-label="Image ID" placeholder="" value="">
                    </div>
                    <div class="form-group">
                        <label for="public_port_import">Public Port For LEDEForge</label>
                        <input type="text" disabled="disabled" id="public_port_import" class="form-control" aria-label="Image ID" placeholder="" value="">
                    </div>
                    <div class="form-group">
                        <label for="name_import">Name for new Container</label>
                        <input type="text" id="name_import" class="form-control" aria-label="Port for LEDEForge Worker" placeholder="" value="">
                    </div>
                    <div class="form-group">
                        <label for="connstr_import">Connection String for new Container</label>
                        <input type="text" id="connstr_import" class="form-control" aria-label="Port for LEDEForge Worker" placeholder="" value="">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="import_into_ledeforge()">Import</button>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        function import_into_ledeforge() {
            const name = $("#name_import").val();
            const container_id = $("#container_id_import").val();
            const connection_string = $("#connstr_import").val();
            $.post('{% url 'container_list' %}', {
                name: name,
                container_id: container_id,
                endpoint_id: "{{ endpoint.id }}",
                connection_string: connection_string
            }, function (data, status, xhr) {
                location.href = '{% url 'container_detail' 2147483647 %}'.replace("2147483647", data.id)
            });
        }
    </script>
{% endblock %}