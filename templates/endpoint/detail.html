{% extends 'frame.html' %}
{% block content %}
    <h4>Docker Endpoint: {{ endpoint.name }}</h4>
    <p><b>Kernel Version:</b> {{ endpoint.data.KernelVersion }}</p>
    <p><b>Containers:</b> {{ endpoint.data.Containers }} ({{ endpoint.data.ContainersRunning }} Running, {{ endpoint.data.ContainersPaused }} Paused, {{ endpoint.data.ContainersStopped }} Stopped)</p>
    <hr/>
    <h4>Images</h4>
    <p>Manage docker images, pull or push, or create one for LEDEForge.</p>
    <button class="btn btn-default" data-toggle="modal" data-target="#docker_build_modal">Build LEDEForge Worker Here</button>
    <a href="{% url "endpoint_docker_build" endpoint.id %}" class="btn btn-default">Pull from Registry</a>
    <br/>
    <br/>
    <p><b>Note:</b> Only images generated by LEDEForge are shown here.</p>
    <table class="table">
        <thead>
        <tr>
            <th>Image ID</th>
            <th>Size</th>
            <th>Operation</th>
        </tr>
        </thead>
        <tbody>
        {% for k in endpoint.images %}
            <tr>
                <td style="font-family: monospace">{{ k.Id | slice:"7:23" }}</td>
                <td>{{ k.Size | filesizeformat }}</td>
                <td>
                    <div class="btn-group btn-group-xs">
                        <button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            Operation <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a href="#" onclick="show_create_container_modal('{{ k.Id | slice:"7:" }}')">Create Container from Image</a></li>
                            <li role="separator" class="divider"></li>
                            <li><a href="#">Push to Docker Registry</a></li>
                        </ul>
                    </div>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    <h4>Containers</h4>
    <p>Show LEDEForge containers on this endpoint.</p>
    <p><b>Note:</b> Containers not created by LEDEForge Image won't show up here.</p>
    <table class="table">
        <thead>
        <tr>
            <th>Container ID</th>
            <th>Image ID</th>
            <th>Command</th>
            <th>Status and Operation</th>
        </tr>
        </thead>
        <tbody>
        {% for k in endpoint.containers %}
            <tr>
                <td style="font-family: monospace">{{ k.Id | slice:"16" }}</td>
                <td style="font-family: monospace">{{ k.Image | slice:"16" }}</td>
                <td style="font-family: monospace">{{ k.Command | slice:"43" }}</td>
                <td>
                    <div class="btn-group btn-group-xs">
                        <button type="button" class="btn btn-xs btn-default">{{ k.State }}</button>
                        <button type="button" class="btn btn-xs btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <span class="caret"></span>
                            <span class="sr-only">Toggle Dropdown</span>
                        </button>
                        <ul class="dropdown-menu">
                            {% if k.State != 'running' %}
                            <li><a href="#">Start</a></li>
                            {% else %}
                            <li><a href="#">Stop</a></li>
                            <li><a href="#">Restart</a></li>
                            {% endif %}
                            <li role="separator" class="divider"></li>
                            <li><a href="#">Import Into LEDEForge</a></li>
                        </ul>
                    </div>

                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
{% endblock %}
{% block model %}
    <div class="modal fade" id="docker_build_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">Build LEDEForge Worker Image</h4>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="ignore">Select DockerFile</label>
                        <select id="ignore" class="form-control">
                            <option value=".">LEDEForge DockerFile</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="button" onclick="start_build()" class="btn btn-primary">Start Build</button>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        function start_build() {
            const v = $("#ignore").val();
            console.log(v);
            $.post('{% url 'endpoint_docker_build' endpoint.id %}', {path: v}, function (data, status, xhr) {
                location.href = '{% url 'queue_output' "aaaaaaaaaa" %}'.replace("aaaaaaaaaa", data.queue_id)
            });
        }
    </script>
    <div class="modal fade" id="docker_create_container_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">Create LEDEForge Container from LEDEForge Image</h4>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="image_id">Image ID</label>
                        <input type="text" disabled="disabled" id="image_id" class="form-control" aria-label="Image ID" placeholder="" value="">
                    </div>
                    <div class="form-group">
                        <label for="port">Expose Port For LEDEForge Access</label>
                        <div class="input-group">
                            <span class="input-group-addon">0.0.0.0:</span>
                            <input type="text" id="port" class="form-control" aria-label="Port for LEDEForge Worker" placeholder="8765" value="8765" onchange="vc()">
                            <span class="input-group-addon">:8765/tcp</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="connstr">Connection String for new Container</label>
                        <input type="text" id="connstr" class="form-control" aria-label="Port for LEDEForge Worker" placeholder="{{ endpoint.default_connection_string }}"
                               value="{{ endpoint.default_connection_string }}">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="create_container()">Create Container</button>
                </div>
            </div>
        </div>
    </div>
    <script type="text/javascript">
        function show_create_container_modal(image_id) {
            const connstr = $("#connstr");
            $("#image_id").val(image_id);
            connstr.val("{{ endpoint.default_connection_string }}:8765/");
            $("#docker_create_container_modal").modal()
        }

        function vc() {
            const port = $("#port");
            const connstr = $("#connstr");
            console.log(port.val());
            connstr.val("{{ endpoint.default_connection_string }}:" + port.val() + "/")
        }

        function create_container() {
            const image_id = $("#image_id").val();
            const port = $("#port").val();
            $.post('{% url 'endpoint_docker_run' endpoint.id %}', {image_id: image_id, port: port}, function (data, status, xhr) {
                location.reload()
            });
        }
    </script>
    <div class="modal fade" id="docker_pull_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">Modal title</h4>
                </div>
                <div class="modal-body">
                    ...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Save changes</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="docker_push_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">Modal title</h4>
                </div>
                <div class="modal-body">
                    ...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Save changes</button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}